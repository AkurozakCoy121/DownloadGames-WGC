<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mod Platform</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-content {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .badge-green {
            background-color: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .badge-blue {
            background-color: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        .prose {
            max-width: 100%;
        }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: bold;
        }
        .prose p {
            margin-bottom: 1em;
        }
        .prose ul, .prose ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .prose ul {
            list-style: disc;
        }
        .prose ol {
            list-style: decimal;
        }
        .prose b {
            font-weight: bold;
        }
        .prose i {
            font-style: italic;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header Navigation Bar -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between">
            <a href="#" id="home-link" class="text-2xl font-bold text-gray-900 mb-4 md:mb-0">Mod Hub</a>
            <div class="flex items-center space-x-4 md:space-x-6">
                <a href="#" id="home-nav" class="text-gray-600 hover:text-blue-600 transition-colors duration-200 font-medium">Beranda</a>
                <a href="#" id="news-nav" class="text-gray-600 hover:text-blue-600 transition-colors duration-200 font-medium">News</a>
                <a href="#" id="upload-nav" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium">Upload Mod</a>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8">
        <!-- Home Page -->
        <section id="home-page" class="main-content">
            <div class="mb-8">
                <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-2">Selamat Datang di Mod Hub</h1>
                <p class="text-lg text-gray-600 text-center">Temukan dan bagikan mod game favoritmu!</p>
            </div>
            
            <!-- Search & Categories -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <div class="relative mb-4">
                    <input type="text" id="search-bar" placeholder="Cari mod atau game..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>
                    </svg>
                </div>
                <div class="flex flex-wrap gap-2 text-sm text-gray-700">
                    <span class="font-semibold">Kategori:</span>
                    <div id="categories-container" class="flex flex-wrap gap-2">
                        <!-- Categories will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Mods List -->
            <div id="mods-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Mods will be rendered here dynamically -->
            </div>

            <div id="no-mods-found" class="hidden text-center text-gray-500 mt-12">
                <p class="text-lg">Mod tidak ditemukan.</p>
            </div>
        </section>

        <!-- News Page -->
        <section id="news-page" class="main-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">News & Updates</h2>
            <div id="news-list" class="space-y-6">
                <!-- News articles will be rendered here -->
            </div>
            
            <!-- Admin News Upload Form -->
            <div id="admin-news-upload" class="hidden mt-12 bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-4">Buat Berita Baru</h3>
                <form id="news-upload-form" class="space-y-4">
                    <div>
                        <label for="news-title" class="block text-gray-700 mb-1">Judul Berita</label>
                        <input type="text" id="news-title" class="w-full p-2 border rounded-md" placeholder="Judul Berita Baru" required>
                    </div>
                    <div>
                        <label for="news-content" class="block text-gray-700 mb-1">Isi Berita</label>
                        <textarea id="news-content" rows="6" class="w-full p-2 border rounded-md" placeholder="Isi berita di sini..." required></textarea>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Publish</button>
                </form>
            </div>
        </section>

        <!-- Upload Page -->
        <section id="upload-page" class="main-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Upload Mod</h2>
            <div class="p-8 max-w-4xl mx-auto bg-white rounded-lg shadow-xl">
                <form id="upload-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-1">Kategori Mod</label>
                            <input type="text" name="modCategory" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Contoh: Modpack, Skin, Kendaraan" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Nama Game</label>
                            <input type="text" name="gameName" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="Contoh: Grand Theft Auto V" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">URL Gambar Utama</label>
                            <input type="url" name="mainImageUrl" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="https://contoh.com/gambar.jpg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">URL File Mod</label>
                            <input type="url" name="downloadUrl" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors" placeholder="https://contoh.com/file.zip" required>
                        </div>
                    </div>

                    <div id="detail-images-container" class="space-y-4">
                        <label class="block text-gray-700">URL Gambar Detail</label>
                        <div class="flex gap-2">
                            <input type="url" name="detailImageUrls" class="w-full p-2 border rounded-md" placeholder="URL gambar #1">
                        </div>
                    </div>
                    <button type="button" id="add-image-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Tambah Gambar</button>

                    <div>
                        <label class="block text-gray-700 mb-1">Deskripsi Mod</label>
                        <textarea name="description" rows="5" class="w-full p-2 border rounded-md" placeholder="Jelaskan mod Anda di sini..." required></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-1">Nama Author</label>
                            <input type="text" name="author" class="w-full p-2 border rounded-md" placeholder="Nama Anda" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Versi Mod</label>
                            <input type="text" name="modVersion" class="w-full p-2 border rounded-md" placeholder="Contoh: v1.0">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Email/Website Author (Opsional)</label>
                            <input type="url" name="authorContact" class="w-full p-2 border rounded-md" placeholder="opsional">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Bahasa Deskripsi</label>
                            <select name="language" class="w-full p-2 border rounded-md">
                                <option value="id">Indonesia</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="is18Plus" name="is18Plus" class="w-4 h-4 text-blue-600 rounded">
                            <label for="is18Plus" class="text-gray-700">18+ (Konten Dewasa)</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="isSoon" name="isSoon" class="w-4 h-4 text-blue-600 rounded">
                            <label for="isSoon" class="text-gray-700">Mod Segera Rilis</label>
                        </div>
                    </div>

                    <div id="release-date-field" class="hidden">
                        <label for="releaseDate" class="block text-gray-700 mb-1">Jadwal Rilis</label>
                        <input type="date" id="releaseDate" name="releaseDate" class="w-full p-2 border rounded-md">
                    </div>
                    
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <h4 class="font-semibold mb-2">Aturan Upload Mods</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>File harus berfungsi penuh dan bermanfaat untuk komunitas.</li>
                            <li>Mod tidak mengandung game bajakan atau melanggar hak cipta.</li>
                            <li>Mod bebas virus dan aman digunakan.</li>
                            <li>Screenshot berkualitas tinggi, tanpa watermark situs lain.</li>
                            <li>Screenshot harus menampilkan perubahan yang dibuat mod.</li>
                            <li>Deskripsi menjelaskan mod dengan jelas dan tanpa kesalahan ketik.</li>
                            <li>Mod tidak menyinggung konflik politik atau militer yang sedang atau baru saja terjadi.</li>
                        </ul>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Upload Mod</button>
                </form>
            </div>
        </section>

        <!-- Mod Detail Page -->
        <section id="detail-page" class="main-content">
            <div id="detail-content" class="bg-white p-8 rounded-lg shadow-xl max-w-4xl mx-auto">
                <!-- Mod details will be rendered here -->
            </div>
        </section>

    </main>

    <!-- Modal/Dialog Box -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-body" class="mb-4"></div>
            <div class="flex justify-end">
                <button id="modal-close" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- Privacy Policy Section -->
    <section id="privacy-policy" class="bg-white py-12 px-4 shadow-inner text-gray-700 hidden">
        <div class="container mx-auto max-w-4xl">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">Kebijakan Privasi</h2>
            <p class="mb-4">Kami menghormati privasi pengguna sepenuhnya. Semua data pribadi, termasuk akun dan informasi kontak, dijamin aman 100%. Data hanya digunakan untuk keperluan internal situs ini dan tidak dibagikan ke pihak ketiga tanpa izin pengguna.</p>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto text-center px-4">
            <p>&copy; 2025 Mod Hub. Hak Cipta Dilindungi.</p>
            <p id="footer-user-id" class="text-xs text-gray-400 mt-2"></p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state variables
        let db;
        let auth;
        let currentUser = null;
        let currentPage = 'home';
        let allMods = [];
        const userModCounts = {};

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyAlGXpZSyQab7riDteV5ppS3DXDJQHywKw",
            authDomain: "modmanagerpro-248f5.firebaseapp.com",
            projectId: "modmanagerpro-248f5",
            storageBucket: "modmanagerpro-248f5.firebasestorage.app",
            messagingSenderId: "594650288669",
            appId: "1:594650288669:web:3074c3f2f0249bc6f1ecf4",
            measurementId: "G-VLWZDSRS3W"
        };
        const initialAuthToken = '';
        const appId = 'modmanagerpro-248f5';

        // --- UI Elements ---
        const pages = {
            home: document.getElementById('home-page'),
            upload: document.getElementById('upload-page'),
            detail: document.getElementById('detail-page'),
            news: document.getElementById('news-page'),
        };
        const navLinks = {
            home: document.getElementById('home-nav'),
            upload: document.getElementById('upload-nav'),
            news: document.getElementById('news-nav'),
        };
        const modsList = document.getElementById('mods-list');
        const newsList = document.getElementById('news-list');
        const searchBar = document.getElementById('search-bar');
        const categoriesContainer = document.getElementById('categories-container');
        const uploadForm = document.getElementById('upload-form');
        const detailImagesContainer = document.getElementById('detail-images-container');
        const addImageBtn = document.getElementById('add-image-btn');
        const isSoonCheckbox = document.getElementById('isSoon');
        const releaseDateField = document.getElementById('release-date-field');
        const noModsFound = document.getElementById('no-mods-found');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close');
        const adminNewsUpload = document.getElementById('admin-news-upload');
        const newsUploadForm = document.getElementById('news-upload-form');
        const footerUserId = document.getElementById('footer-user-id');
        
        // --- Firebase Initialization & Authentication ---
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Authentication error:", error);
                            }
                        }
                        if (currentUser) {
                            footerUserId.textContent = `User ID: ${currentUser.uid}`;
                        }
                        // Start fetching data after auth is ready
                        fetchMods();
                        fetchNews();
                    });
                }
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showDialog("Gagal menginisialisasi Firebase. Pastikan konfigurasi sudah benar.", "Error");
            }
        };

        // --- UI Functions ---
        const showDialog = (message, title = "Info") => {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modal.style.display = 'flex';
        };

        const renderPage = (pageName) => {
            Object.values(pages).forEach(page => page.style.display = 'none');
            const targetPage = pages[pageName];
            if (targetPage) {
                targetPage.style.display = 'block';
                currentPage = pageName;
                window.scrollTo(0, 0); // Scroll to top on page change
            }
        };

        const renderHomePage = (modsToRender) => {
            modsList.innerHTML = '';
            if (!modsToRender || modsToRender.length === 0) {
                noModsFound.classList.remove('hidden');
                return;
            }
            noModsFound.classList.add('hidden');
            modsToRender.forEach(mod => {
                // Check if mod is "soon" and if release date is in the future
                const isSoon = mod.isSoon && new Date(mod.releaseDate) > new Date();
                
                const modCard = document.createElement('div');
                modCard.className = `bg-white rounded-lg shadow-md p-4 transition-transform transform hover:scale-105 cursor-pointer`;
                
                let badgeHtml = '';
                const modCount = userModCounts[mod.authorId];
                if (modCount >= 300) {
                    badgeHtml = `<span class="badge-green mr-2">✔</span>`;
                } else if (mod.author === 'Admin') {
                    badgeHtml = `<span class="badge-blue mr-2">✔</span>`;
                }

                modCard.innerHTML = `
                    <img src="${mod.mainImageUrl}" alt="${mod.gameName} Mod" class="w-full h-48 object-cover rounded-md mb-4">
                    <h3 class="text-xl font-bold mb-1">${mod.gameName} - ${mod.modCategory}</h3>
                    <p class="text-sm text-gray-500 mb-2">oleh ${badgeHtml} ${mod.author}</p>
                    <p class="text-sm text-gray-600">${mod.description.substring(0, 100)}...</p>
                    ${isSoon ? '<p class="text-red-500 font-bold mt-2">Segera Hadir</p>' : ''}
                `;
                modCard.addEventListener('click', () => {
                    if (!isSoon) {
                        renderModDetailPage(mod.id);
                    }
                });
                modsList.appendChild(modCard);
            });
        };

        const renderModDetailPage = async (modId) => {
            const modRef = doc(db, `artifacts/${appId}/public/data/mods`, modId);
            const modSnap = await getDoc(modRef);

            if (!modSnap.exists()) {
                showDialog("Mod tidak ditemukan.", "Error");
                return;
            }

            const mod = { id: modSnap.id, ...modSnap.data() };
            const detailContent = document.getElementById('detail-content');
            
            // Check for overdue mod and redirect
            if (mod.isSoon && new Date(mod.releaseDate) < new Date() && mod.downloadUrl) {
                window.location.href = 'https://blockir.netlify.app/';
                return;
            }

            let badgeHtml = '';
            const modCount = userModCounts[mod.authorId];
            if (modCount >= 300) {
                badgeHtml = `<span class="badge-green mr-2">✔</span>`;
            } else if (mod.author === 'Admin') {
                badgeHtml = `<span class="badge-blue mr-2">✔</span>`;
            }

            detailContent.innerHTML = `
                <div class="flex items-start mb-4">
                    <img src="${mod.mainImageUrl}" alt="${mod.gameName} Mod" class="w-24 h-24 object-cover rounded-lg shadow-md mr-4 md:w-48 md:h-48">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">${mod.gameName} - ${mod.modCategory}</h2>
                        <p class="text-lg text-gray-600">oleh ${badgeHtml} ${mod.author}</p>
                        <p class="text-sm text-gray-500 mt-1">ID Game: ${mod.modId}</p>
                        <p class="text-sm text-gray-500 mt-1">Versi Mod: ${mod.modVersion}</p>
                        ${mod.authorContact ? `<p class="text-sm text-gray-500 mt-1">Kontak: <a href="${mod.authorContact}" class="text-blue-600 hover:underline" target="_blank">${mod.authorContact}</a></p>` : ''}
                    </div>
                </div>

                <!-- Mod Description -->
                <div class="prose max-w-none mt-6">
                    <h3 class="text-xl font-bold mb-2">Deskripsi</h3>
                    <p>${mod.description.replace(/\n/g, '<br>')}</p>
                </div>

                <!-- Detail Images -->
                ${mod.detailImageUrls && mod.detailImageUrls.length > 0 && mod.detailImageUrls[0] !== '' ? `
                <h3 class="text-xl font-bold mt-6 mb-2">Screenshots</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${mod.detailImageUrls.map(url => `<img src="${url}" alt="Screenshot" class="w-full h-auto object-cover rounded-lg shadow-md">`).join('')}
                </div>
                ` : ''}

                <!-- Download Button -->
                <div class="mt-8 text-center">
                    <button id="download-btn" class="bg-green-600 text-white py-4 px-8 rounded-lg font-bold text-xl hover:bg-green-700 transition-colors shadow-lg">Download</button>
                    <p id="download-timer" class="mt-2 text-sm text-gray-600 hidden"></p>
                </div>

                <!-- Comments Section -->
                <div class="mt-12">
                    <h3 class="text-xl font-bold mb-4">Komentar</h3>
                    <div id="comments-list" class="space-y-4 mb-6">
                        <!-- Comments will be rendered here -->
                    </div>
                    <form id="comment-form" class="space-y-4">
                        <textarea id="comment-text" class="w-full p-2 border rounded-lg" rows="3" placeholder="Tambahkan komentar..." required></textarea>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Kirim Komentar</button>
                    </form>
                </div>
            `;
            
            // Handle comments
            const commentsRef = collection(db, `artifacts/${appId}/public/data/mods/${mod.id}/comments`);
            const unsubscribeComments = onSnapshot(commentsRef, (snapshot) => {
                const commentsList = document.getElementById('comments-list');
                commentsList.innerHTML = '';
                snapshot.forEach(commentDoc => {
                    const commentData = commentDoc.data();
                    const commentElement = document.createElement('div');
                    commentElement.className = 'bg-gray-100 p-4 rounded-lg';
                    commentElement.innerHTML = `
                        <p class="font-semibold text-gray-800">${commentData.author}</p>
                        <p class="text-sm text-gray-600">${commentData.content}</p>
                        ${commentData.authorId === currentUser?.uid ? `<button class="text-red-500 hover:text-red-700 text-xs mt-2" onclick="deleteComment('${mod.id}', '${commentDoc.id}')">Hapus</button>` : ''}
                    `;
                    commentsList.appendChild(commentElement);
                });
            });

            // Handle comment submission
            document.getElementById('comment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const commentText = document.getElementById('comment-text').value;
                if (!commentText.trim() || !currentUser) {
                    showDialog("Silakan login untuk berkomentar.");
                    return;
                }
                try {
                    await addDoc(commentsRef, {
                        content: commentText,
                        author: currentUser.displayName || `Pengguna Anonim`,
                        authorId: currentUser.uid,
                        createdAt: serverTimestamp(),
                    });
                    document.getElementById('comment-text').value = '';
                } catch (error) {
                    console.error("Error adding comment:", error);
                    showDialog("Gagal mengirim komentar.", "Error");
                }
            });

            // Handle download button
            const downloadBtn = document.getElementById('download-btn');
            const downloadTimer = document.getElementById('download-timer');
            let timer;
            downloadBtn.addEventListener('click', () => {
                let timeLeft = 20;
                downloadBtn.disabled = true;
                downloadTimer.classList.remove('hidden');
                downloadTimer.textContent = `Mengunduh dalam ${timeLeft} detik...`;
                timer = setInterval(() => {
                    timeLeft--;
                    downloadTimer.textContent = `Mengunduh dalam ${timeLeft} detik...`;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        window.location.href = mod.downloadUrl;
                        downloadBtn.disabled = false;
                        downloadTimer.classList.add('hidden');
                    }
                }, 1000);
            });
            renderPage('detail');
        };
        
        // --- Firebase Interaction Functions ---
        const fetchUserModCounts = async () => {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef);
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                userModCounts[doc.id] = doc.data().modCount || 0;
            });
        };

        const fetchMods = () => {
            if (!db) return;
            const modsRef = collection(db, `artifacts/${appId}/public/data/mods`);
            const q = query(modsRef);
            
            onSnapshot(q, async (snapshot) => {
                allMods = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                allMods.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                await fetchUserModCounts();
                renderHomePage(allMods);
                updateCategories();
            }, (error) => {
                console.error("Error fetching mods:", error);
            });
        };

        const fetchNews = () => {
            if (!db) return;
            const newsRef = collection(db, `artifacts/${appId}/public/data/news`);
            const q = query(newsRef);

            onSnapshot(q, (snapshot) => {
                newsList.innerHTML = '';
                snapshot.forEach(newsDoc => {
                    const news = newsDoc.data();
                    const newsElement = document.createElement('div');
                    newsElement.className = 'bg-white rounded-lg shadow-md p-6';
                    newsElement.innerHTML = `
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${news.title}</h3>
                        <p class="text-sm text-gray-500 mb-4">Diterbitkan pada ${news.createdAt?.toDate().toLocaleDateString()}</p>
                        <p class="text-gray-700">${news.content.replace(/\n/g, '<br>')}</p>
                    `;
                    newsList.appendChild(newsElement);
                });
                // Show news upload form if user is 'Admin' (simplified for demo)
                if (currentUser && currentUser.displayName === 'Admin') {
                    adminNewsUpload.classList.remove('hidden');
                }
            });
        };
        
        const deleteComment = async (modId, commentId) => {
            if (confirm("Apakah Anda yakin ingin menghapus komentar ini?")) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/mods/${modId}/comments`, commentId));
                    showDialog("Komentar berhasil dihapus.", "Sukses");
                } catch (error) {
                    console.error("Error deleting comment:", error);
                    showDialog("Gagal menghapus komentar.", "Error");
                }
            }
        };

        // --- Helper Functions ---
        const generateUniqueModId = async () => {
            const modsRef = collection(db, `artifacts/${appId}/public/data/mods`);
            const querySnapshot = await getDocs(modsRef);
            let maxId = 0;
            querySnapshot.forEach(doc => {
                const mod = doc.data();
                if (mod.modId && typeof mod.modId === 'number' && mod.modId > maxId) {
                    maxId = mod.modId;
                }
            });
            return maxId + 1;
        };

        const updateCategories = () => {
            const categories = new Set(allMods.map(mod => mod.modCategory).filter(Boolean));
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-300 transition-colors';
                button.addEventListener('click', () => {
                    searchBar.value = category;
                    const filteredMods = allMods.filter(mod => mod.modCategory.toLowerCase().includes(category.toLowerCase()));
                    renderHomePage(filteredMods);
                });
                categoriesContainer.appendChild(button);
            });
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            renderPage('home');
        });

        navLinks.home.addEventListener('click', (e) => {
            e.preventDefault();
            searchBar.value = '';
            renderHomePage(allMods);
            renderPage('home');
        });

        navLinks.upload.addEventListener('click', (e) => {
            e.preventDefault();
            renderPage('upload');
            // Set author name if logged in
            if (currentUser) {
                uploadForm.author.value = currentUser.displayName || '';
            }
        });
        
        navLinks.news.addEventListener('click', (e) => {
            e.preventDefault();
            renderPage('news');
        });
        
        modalCloseBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Search functionality
        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredMods = allMods.filter(mod =>
                mod.gameName.toLowerCase().includes(query) ||
                mod.modCategory.toLowerCase().includes(query) ||
                mod.author.toLowerCase().includes(query)
            );
            renderHomePage(filteredMods);
        });

        // Dynamic image input for upload form
        addImageBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="url" name="detailImageUrls" class="w-full p-2 border rounded-md" placeholder="URL gambar #${detailImagesContainer.children.length + 1}">
                <button type="button" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Hapus</button>
            `;
            div.querySelector('button').addEventListener('click', () => div.remove());
            detailImagesContainer.appendChild(div);
        });

        isSoonCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                releaseDateField.classList.remove('hidden');
            } else {
                releaseDateField.classList.add('hidden');
            }
        });

        // Mod upload form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(uploadForm);
            const modData = Object.fromEntries(formData.entries());
            modData.detailImageUrls = Array.from(document.querySelectorAll('input[name="detailImageUrls"]')).map(el => el.value).filter(Boolean);
            modData.is18Plus = document.getElementById('is18Plus').checked;
            modData.isSoon = document.getElementById('isSoon').checked;
            
            // Generate a unique ID
            const modId = await generateUniqueModId();
            
            // Create the new mod object
            const newMod = {
                modId,
                modCategory: modData.modCategory,
                gameCategory: 'GTA', // Hardcoded as per request
                gameName: modData.gameName,
                mainImageUrl: modData.mainImageUrl,
                detailImageUrls: modData.detailImageUrls,
                description: modData.description,
                author: modData.author,
                authorId: currentUser.uid,
                language: modData.language,
                is18Plus: modData.is18Plus,
                authorContact: modData.authorContact,
                isSoon: modData.isSoon,
                releaseDate: modData.releaseDate,
                modVersion: modData.modVersion,
                downloadUrl: modData.downloadUrl,
                status: 'Pending',
                createdAt: serverTimestamp(),
            };

            showDialog("Mod sedang diunggah. Status: Pending...", "Status Upload");

            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/mods`), newMod);
                
                // Simulate auto-check after 5 seconds
                setTimeout(async () => {
                    await updateDoc(docRef, { status: 'Success' });
                    // Increment author's mod count for badge system
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
                    await setDoc(userRef, { modCount: increment(1) }, { merge: true });
                    showDialog("Mod berhasil diunggah! Status: Success.", "Status Upload");
                }, 5000);
            } catch (error) {
                console.error("Error uploading mod:", error);
                showDialog("Gagal mengunggah mod. Silakan coba lagi.", "Error");
            }
        });

        // News upload form submission (Admin-only)
        newsUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || currentUser.displayName !== 'Admin') {
                showDialog("Anda tidak memiliki izin untuk mengunggah berita.", "Izin Ditolak");
                return;
            }
            const title = document.getElementById('news-title').value;
            const content = document.getElementById('news-content').value;
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/news`), {
                    title,
                    content,
                    author: 'Admin',
                    createdAt: serverTimestamp(),
                });
                showDialog("Berita berhasil dipublikasikan!", "Sukses");
                newsUploadForm.reset();
            } catch (error) {
                console.error("Error publishing news:", error);
                showDialog("Gagal mempublikasikan berita.", "Error");
            }
        });
        
    </script>
</body>
</html>
